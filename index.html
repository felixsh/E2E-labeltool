<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>E2E-labeltool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="toolbar">
      <!-- LEFT: PCD controls -->
      <div class="left">
        <label class="file">
          <input id="fileInput" type="file" accept=".pcd,.bin,.npy" />
          Load
        </label>
        <button id="demoBtn" type="button">Demo</button>

        <label>
          Point size
          <input id="ptSize" type="range" min="0.01" max="0.50" step="0.01" value="0.08" />
          <span id="ptSizeVal">0.08 m</span>
        </label>

        <label>
          Color
          <select id="colorMode">
            <option value="height" selected>Height</option>
            <option value="intensity">Intensity</option>
            <option value="distance">Distance</option>
            <option value="solid">Solid</option>
          </select>
        </label>

        <button id="viewTopBtn" disabled>Top</button>
        <button id="viewIsoBtn" disabled>Iso</button>
      </div>

      <!-- RIGHT: Spline controls -->
      <div class="right">
        <label>
          Curve
          <select id="curveType">
            <option value="basis" selected>Basis</option>
            <option value="natural">Natural</option>
            <option value="catmullrom">CatmullRom</option>
          </select>
        </label>

        <span id="alphaWrap">
          <label>
            Î±
            <input id="alpha" type="range" min="0.0" max="1.0" step="0.01" value="0.50" />
            <span id="alphaVal">0.50</span>
          </label>
        </span>

        <button id="samplesBtn" type="button" class="toggle-btn" title="Toggle samples & charts (S)" aria-pressed="true">Samples</button>

        <button id="weightsBtn" type="button" class="toggle-btn" title="Adjust optimization weights (W)">Weights</button>
        <button id="optimizeBtn" title="Optimize sampling (jerk/limits)">Optimize</button>
        <button id="exportSamplesBtn" title="Export JSON">Export</button>

        <button id="helpBtn" title="Keyboard shortcuts">Help</button>
      </div>
    </div>
  </header>

  <main>
    <div id="stage3d">
      <!-- Mode badge -->
      <div id="modeBadge" class="badge three">3D</div>
      <div id="scenarioInfo" aria-live="polite"></div>

      <!-- Weights panel (top-left) -->
      <div id="weightsPanel" aria-hidden="true">
        <div class="panel-title">Optimizer Weights</div>
        <div class="slider-row">
          <label for="weightJerk">Jerk</label>
          <input id="weightJerk" type="range" min="0" max="8" step="0.01" value="1" />
          <input id="weightJerkNumber" type="number" min="0" max="8" step="0.01" value="1.00" />
        </div>
        <div class="slider-row">
          <label for="weightVel">Velocity</label>
          <input id="weightVel" type="range" min="0" max="4" step="0.01" value="0.10" />
          <input id="weightVelNumber" type="number" min="0" max="4" step="0.01" value="0.10" />
        </div>
        <div class="slider-row">
          <label for="weightAcc">Acceleration</label>
          <input id="weightAcc" type="range" min="0" max="4" step="0.01" value="0.10" />
          <input id="weightAccNumber" type="number" min="0" max="4" step="0.01" value="0.10" />
        </div>
      </div>

      <!-- Charts (top-right) -->
      <div id="charts">
        <svg id="velChart"></svg>
        <svg id="accTotalChart"></svg>
        <svg id="jerkChart"></svg>
      </div>

      <!-- Legend (bottom-right, vertical) -->
      <div id="legend">
        <div class="labels">
          <div id="legendTitle">Height (m)</div>
          <div class="ticks">
            <span id="legendMax"></span>
            <span id="legendMin"></span>
          </div>
        </div>
        <canvas id="legendCanvas" width="16" height="160"></canvas>
      </div>
    </div>
  </main>

  <footer>
    <div id="status">Load a .bin, .pcd, or .npy file, or try the Demo</div>
    <div id="statusExtra" aria-live="polite"></div>
  </footer>

  <dialog id="manouverDlg">
    <form method="dialog" class="dialog-body manouver-dialog" id="manouverForm">
      <h3>Select manouver type</h3>
      <p class="manouver-intro">Choose the label that best describes this export.</p>
      <div id="manouverOptions" class="manouver-options"></div>
      <div class="actions">
        <button type="button" id="manouverCancel">Cancel</button>
        <button type="submit" id="manouverConfirm" disabled>Export</button>
      </div>
    </form>
  </dialog>

  <!-- Help dialog -->
  <dialog id="helpDlg">
    <div class="dialog-body">
      <h3>Help</h3>
      <h4>Buttons</h4>
      <div class="help-grid">
        <span class="help-key">Load</span><span class="help-desc">Choose a point cloud (.pcd/.bin) and/or trajectory (.npy)</span>
        <span class="help-key">Demo</span><span class="help-desc">Load the bundled sample dataset</span>
        <span class="help-key">Top / Iso</span><span class="help-desc">Camera presets (3D only)</span>
      </div>

      <h4>Keyboard</h4>
      <div class="help-grid">
        <span class="help-key"><kbd>Space</kbd></span><span class="help-desc">Toggle 2D/3D view</span>
        <span class="help-key"><kbd>Delete</kbd>/<kbd>Backspace</kbd></span><span class="help-desc">Delete selected control point</span>
        <span class="help-key"><kbd>Z</kbd> / <kbd>Y</kbd></span><span class="help-desc">Undo / Redo</span>
        <span class="help-key"><kbd>S</kbd></span><span class="help-desc">Toggle samples & mini charts</span>
        <span class="help-key"><kbd>O</kbd></span><span class="help-desc">Run optimization</span>
        <span class="help-key"><kbd>W</kbd></span><span class="help-desc">Toggle optimizer weights panel</span>
        <span class="help-key"><kbd>L</kbd></span><span class="help-desc">Open the Load dialog</span>
        <span class="help-key"><kbd>E</kbd></span><span class="help-desc">Export JSON (controls, samples, status)</span>
      </div>

      <h4>Mouse</h4>
      <div class="help-grid">
        <span class="help-key">Wheel</span><span class="help-desc">Zoom</span>
        <span class="help-key">Left click</span><span class="help-desc">Move control/sample points (drag). In 2D, clicking empty space adds a control point. In 3D, click/drag empty space rotates the view.</span>
        <span class="help-key">Right click</span><span class="help-desc">Pan view</span>
      </div>

      <p class="help-note">Footer shows the currently loaded point cloud and trajectory files.</p>
      <div class="actions">
        <button id="helpClose">Close</button>
      </div>
    </div>
  </dialog>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
      "npyjs": "https://cdn.jsdelivr.net/npm/npyjs@1.0.4/dist/index.js"
    }
  }
  </script>

  <!-- Config BEFORE app -->
  <script src="config.js"></script>
  <!-- App entry loads modules -->
  <script type="module" src="app.js"></script>
</body>
</html>
